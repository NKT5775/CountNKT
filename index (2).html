<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>King Of Word ‚Äî Word Counter Pro (Final Version)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220;
    --panel:#0f1620; --card:#111820;
    --text:#f0f4f8; --muted:#b8c5d3;
    --accent:#0d6efd; --accent2:#0dcaf0;
    --glow: rgba(13,110,253,0.12);
    --radius:12px;
    --shadow:0 12px 30px rgba(2,6,23,0.6);
    font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }
  body.light{
    --bg:#f4f7fa; --panel:#ffffff; --card:#f8f9fb;
    --text:#0a0a0a; --muted:#4e555e;
    --accent:#0d6efd; --accent2:#0dcaf0;
    --glow: rgba(13,110,253,0.12);
    --shadow:0 10px 30px rgba(2,6,23,0.06);
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--glow); } 70% { box-shadow: 0 0 0 10px rgba(13,110,253,0); } 100% { box-shadow: 0 0 0 0 rgba(13,110,253,0); } }
  
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .app{min-height:100vh;display:grid;grid-template-columns:58% 42%;gap:18px;padding:18px; animation: fadeIn 0.6s ease-out forwards; position: relative; overflow-x: hidden;}
  .editor,.panel{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px; transition: transform 0.2s, box-shadow 0.2s; }
  .editor{display:flex;flex-direction:column;height:calc(100vh - 36px)}
  .editor-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:12px}
  .brand{font-weight:700;color:var(--accent);font-size:18px}
  .controls{display:flex;gap:8px;align-items:center;position:relative;}
  textarea#textarea{flex:1;width:100%;padding:18px;border-radius:12px;border:2px solid transparent;background:var(--card);color:var(--text);font-size:16px;line-height:1.6;resize:vertical;min-height:220px;transition:box-shadow .22s,border-color .18s}
  textarea#textarea:focus{outline:none;box-shadow:0 12px 40px var(--glow);border-color:rgba(0,0,0,0.06)}
  .toolbar{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .btn{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600;display:inline-flex;gap:8px;align-items:center; transition: transform 0.2s, box-shadow 0.2s;}
  .btn:hover{transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15);}
  .btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04)}
  .btn.small{padding:6px 8px;font-size:13px}
  .panel{height:calc(100vh - 36px);overflow:auto}
  .grid-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}
  .stat{background:var(--card);padding:12px;border-radius:10px;text-align:center;transition:transform .18s,box-shadow .18s}
  .stat:hover {transform: translateY(-5px); box-shadow: 0 10px 25px var(--glow);}
  .num{font-weight:700;color:var(--accent);font-size:20px; transition: color 0.3s;}
  .label{color:var(--muted);font-size:13px;margin-top:6px}
  .section{margin-bottom:18px}
  .tools-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
  .keyword-list{list-style:none;padding:0;margin:0}
  .keyword-list li{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .bar{height:8px;background:rgba(255,255,255,0.03);border-radius:6px;overflow:hidden;width:120px;margin-left:8px}
  .bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;transition:width .6s}
  .small{font-size:13px;color:var(--muted)}
  select {padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--card);color:var(--text);}

  /* Off-canvas Menu Styles */
  .extras-panel {
      position: fixed; top: 0; right: 0; width: 42%; height: 100%;
      background: var(--bg); padding: 18px;
      box-shadow: -10px 0 30px rgba(0,0,0,0.25);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      overflow-y: auto;
  }
  .extras-panel.show { transform: translateX(0); }
  .extras-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .extras-panel-header h3 { margin: 0; color: var(--accent); }
  .close-btn { font-size: 24px; cursor: pointer; background: none; border: none; color: var(--muted); }
  #overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 999;
      opacity: 0; visibility: hidden;
      transition: opacity 0.4s, visibility 0.4s;
  }
  #overlay.show { opacity: 1; visibility: visible; }
  
  /* Menu Hint */
  #toggleExtras.pulse { animation: pulse 2s infinite; }
  .menu-hint {
      position: absolute; right: 0; top: 120%;
      background: var(--accent); color: white; padding: 8px 12px; border-radius: 8px;
      font-size: 13px; font-weight: 500; z-index: 10; width: max-content;
      opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.3s ease;
  }
  .menu-hint.show { opacity: 1; visibility: visible; transform: translateY(0); }
  .menu-hint::after {
      content: ''; position: absolute; bottom: 100%; right: 18px;
      border-width: 6px; border-style: solid; border-color: transparent transparent var(--accent) transparent;
  }

  @media (max-width:900px){
    .app{grid-template-columns:1fr;padding:12px}
    .editor{height:auto}.panel{height:auto}
    .extras-panel { width: 85%; }
  }
</style>
</head>
<body class="light">

<div class="app" id="app">
  <div class="editor">
    <div class="editor-header">
      <div class="brand">CountNKT</div>
      <div class="controls">
        <select id="uiLang" title="Language"></select>
        <button id="themeToggle" class="btn secondary small" title="Toggle theme">üåì</button>
        <button id="toggleExtras" class="btn secondary small">‚ò∞</button>
        <div class="menu-hint" id="menuHint">M·ªü menu c√¥ng c·ª• t·∫°i ƒë√¢y!</div>
      </div>
    </div>
    <textarea id="textarea" placeholder="D√°n vƒÉn b·∫£n c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
    <div class="toolbar">
        <button id="undoBtn" class="btn secondary small" title="Undo">‚Ü∂</button>
        <button id="redoBtn" class="btn secondary small" title="Redo">‚Ü∑</button>
      <div style="margin-left:auto">
        <button id="exportTxt" class="btn small">üíæ .TXT</button>
        <button id="exportDocx" class="btn small">üìÑ .DOCX</button>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="section">
      <h3 id="titleStats">Th·ªëng k√™</h3>
      <div class="grid-stats">
        <div class="stat"><div class="num" id="statWords">0</div><div class="label" id="lblWords">T·ª´</div></div>
        <div class="stat"><div class="num" id="statChars">0</div><div class="label" id="lblChars">K√Ω t·ª±</div></div>
        <div class="stat"><div class="num" id="statSentences">0</div><div class="label" id="lblSentences">C√¢u</div></div>
        <div class="stat"><div class="num" id="statParagraphs">0</div><div class="label" id="lblParagraphs">ƒêo·∫°n</div></div>
        <div class="stat"><div class="num" id="statLines">0</div><div class="label" id="lblLines">D√≤ng</div></div>
        <div class="stat"><div class="num" id="statTime">0.0s</div><div class="label" id="lblTime">Th·ªùi gian ƒë·ªçc</div></div>
      </div>
    </div>
    <div class="section">
      <h3 id="titleQuick">Thao t√°c nhanh</h3>
      <div class="tools-grid">
        <button id="btnCopy" class="btn small">üìã Sao ch√©p</button>
        <button id="btnClear" class="btn secondary small">üßπ X√≥a</button>
        <button id="btnFindReplace" class="btn secondary small">üîç T√¨m ki·∫øm & s·ª≠a ƒë·ªïi</button>
        <button id="btnUpper" class="btn secondary small">üî† IN HOA</button>
        <button id="btnLower" class="btn secondary small">üî° in th∆∞·ªùng</button>
        <button id="btnTitle" class="btn secondary small">üÖ£ Vi·∫øt Hoa</button>
      </div>
    </div>
    <div class="section">
      <h3 id="titleFreq">Top 5 t·ª´ ph·ªï bi·∫øn</h3>
      <div id="freqList" style="margin-top:8px"></div>
    </div>
    <div class="section">
      <h3 id="titleLongest">Top 5 t·ª´ d√†i nh·∫•t</h3>
      <div id="longList"></div>
    </div>
    <div class="footer" id="footerCopyright">¬© CountNKt ‚Ä¢ <span id="year"></span></div>
  </div>
</div>

<div id="overlay"></div>
<div class="extras-panel" id="extrasPanel">
  <div class="extras-panel-header">
    <h3 id="titleExtrasPanel">C√¥ng c·ª• M·ªü r·ªông</h3>
    <button id="closeExtras" class="close-btn">&times;</button>
  </div>
  <div class="section">
      <h3 id="titleReadability">Ph√¢n t√≠ch kh·∫£ nƒÉng ƒë·ªçc</h3>
      <div class="stat" style="padding: 16px;">
          <div class="num" id="statReadability">0.0</div>
          <div class="label" id="lblReadability">ƒêi·ªÉm Flesch Reading Ease</div>
          <div class="small" style="margin-top: 8px;" id="descReadability">(C√†ng cao c√†ng d·ªÖ ƒë·ªçc. >60 l√† ·ªïn.)</div>
      </div>
  </div>
  <div class="section">
      <h3 id="titleExtraTools">C√¥ng c·ª• b·ªï tr·ª£</h3>
      <div class="tools-grid">
          <button id="btnInverseCase" class="btn secondary small">NGH·ªäCH ƒê·∫¢O CH·ªÆ</button>
          <button id="btnRemoveSpaces" class="btn secondary small">X√≥a kho·∫£ng tr·∫Øng th·ª´a</button>
      </div>
  </div>
  <div class="section">
      <h3 id="titleHistory">L·ªãch s·ª≠</h3>
      <div id="history" style="max-height:250px;overflow:auto"></div>
  </div>
</div>


<script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>

<script>
(() => {
  const textarea = document.getElementById('textarea');
  const statReadability = document.getElementById('statReadability');
  const freqList = document.getElementById('freqList');
  const longList = document.getElementById('longList');
  const historyEl = document.getElementById('history');
  const btnCopy = document.getElementById('btnCopy');
  const btnClear = document.getElementById('btnClear');
  const btnFindReplace = document.getElementById('btnFindReplace');
  const btnUpper = document.getElementById('btnUpper');
  const btnLower = document.getElementById('btnLower');
  const btnTitle = document.getElementById('btnTitle');
  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');
  const themeToggle = document.getElementById('themeToggle');
  const uiLang = document.getElementById('uiLang');
  const btnInverseCase = document.getElementById('btnInverseCase');
  const btnRemoveSpaces = document.getElementById('btnRemoveSpaces');
  const yearEl = document.getElementById('year');
  const exportTxt = document.getElementById('exportTxt');
  const exportDocx = document.getElementById('exportDocx');
  const toggleExtras = document.getElementById('toggleExtras');
  const extrasPanel = document.getElementById('extrasPanel');
  const closeExtras = document.getElementById('closeExtras');
  const overlay = document.getElementById('overlay');
  const menuHint = document.getElementById('menuHint');
  
  const state = { undoStack: [], redoStack: [], history: [] };
  
  const i18n = {
    vi: {
        stats:'Th·ªëng k√™', words:'T·ª´', chars:'K√Ω t·ª±', sentences:'C√¢u', paragraphs:'ƒêo·∫°n', lines:'D√≤ng', read_time:'Th·ªùi gian ƒë·ªçc',
        quick:'Thao t√°c nhanh', copy:'Sao ch√©p', clear:'X√≥a', find:'T√¨m ki·∫øm & s·ª≠a ƒë·ªïi', findPrompt:'T√¨m (ph√¢n bi·ªát ch·ªØ hoa/th∆∞·ªùng):', replacePrompt:'Thay th·∫ø b·∫±ng:', copyError:'Kh√¥ng th·ªÉ sao ch√©p', upper:'IN HOA', lower:'in th∆∞·ªùng', title:'Vi·∫øt Hoa',
        topFreq:'Top 5 t·ª´ ph·ªï bi·∫øn', topLongest:'Top 5 t·ª´ d√†i nh·∫•t',
        readability:'Ph√¢n t√≠ch kh·∫£ nƒÉng ƒë·ªçc', score:'ƒêi·ªÉm Flesch Reading Ease', desc:'(C√†ng cao c√†ng d·ªÖ ƒë·ªçc. >60 l√† ·ªïn.)',
        extraTools:'C√¥ng c·ª• b·ªï tr·ª£', inverse:'NGH·ªäCH ƒê·∫¢O CH·ªÆ', removeSpaces:'X√≥a kho·∫£ng tr·∫Øng th·ª´a',
        history:'L·ªãch s·ª≠',
        extrasTitle: 'C√¥ng c·ª• M·ªü r·ªông', noData: 'Ch∆∞a c√≥ d·ªØ li·ªáu...', exportError: 'Kh√¥ng th·ªÉ xu·∫•t DOCX',
        placeholder:'D√°n vƒÉn b·∫£n c·ªßa b·∫°n v√†o ƒë√¢y...',
        titleUndo:'Ho√†n t√°c', titleRedo:'L√†m l·∫°i', titleTheme:'ƒê·ªïi giao di·ªán', titleLangUI:'Ng√¥n ng·ªØ giao di·ªán'
    },
    en: {
        stats:'Statistics', words:'Words', chars:'Characters', sentences:'Sentences', paragraphs:'Paragraphs', lines:'Lines', read_time:'Reading Time',
        quick:'Quick Actions', copy:'Copy', clear:'Clear', find:'Search & Modify', findPrompt:'Find (case-sensitive):', replacePrompt:'Replace with:', copyError:'Could not copy', upper:'UPPERCASE', lower:'lowercase', title:'Title Case',
        topFreq:'Top 5 Frequent Words', topLongest:'Top 5 Longest Words',
        readability:'Readability Analysis', score:'Flesch Reading Ease Score', desc:'(Higher is easier. >60 is good.)',
        extraTools:'Extra Tools', inverse:'iNVERSE cASE', removeSpaces:'Remove Extra Spaces',
        history:'History',
        extrasTitle: 'Extra Tools', noData: 'No data yet...', exportError: 'Could not export DOCX',
        placeholder:'Paste your text here...',
        titleUndo:'Undo', titleRedo:'Redo', titleTheme:'Toggle theme', titleLangUI:'UI Language'
    },
    es: {
        stats:'Estad√≠sticas', words:'Palabras', chars:'Caracteres', sentences:'Frases', paragraphs:'P√°rrafos', lines:'L√≠neas', read_time:'Tiempo de lectura',
        quick:'Acciones r√°pidas', copy:'Copiar', clear:'Limpiar', find:'Buscar y modificar', findPrompt:'Buscar (distingue may√∫sculas/min√∫sculas):', replacePrompt:'Reemplazar con:', copyError:'No se pudo copiar', upper:'MAY√öSCULAS', lower:'min√∫sculas', title:'T√≠tulo',
        topFreq:'Top 5 palabras frecuentes', topLongest:'Top 5 palabras m√°s largas',
        readability:'An√°lisis de legibilidad', score:'Puntuaci√≥n Flesch', desc:'(M√°s alto es m√°s f√°cil. >60 est√° bien.)',
        extraTools:'Herramientas extra', inverse:'iNVERTIR cASO', removeSpaces:'Eliminar espacios extra',
        history:'Historial',
        extrasTitle: 'Herramientas Extra', noData: 'No hay datos...', exportError: 'No se pudo exportar DOCX',
        placeholder:'Pega tu texto aqu√≠...',
        titleUndo:'Deshacer', titleRedo:'Rehacer', titleTheme:'Cambiar tema', titleLangUI:'Idioma de la interfaz'
    },
    fr: {
        stats:'Statistiques', words:'Mots', chars:'Caract√®res', sentences:'Phrases', paragraphs:'Paragraphes', lines:'Lignes', read_time:'Temps de lecture',
        quick:'Actions rapides', copy:'Copier', clear:'Effacer', find:'Rechercher et modifier', findPrompt:'Chercher (sensible √† la casse):', replacePrompt:'Remplacer par:', copyError:'Copie impossible', upper:'MAJUSCULES', lower:'minuscules', title:'Titre',
        topFreq:'Top 5 mots fr√©quents', topLongest:'Top 5 mots les plus longs',
        readability:'Analyse de lisibilit√©', score:'Score de Flesch', desc:'(Plus haut c\'est facile. >60 c\'est bien.)',
        extraTools:'Outils suppl√©mentaires', inverse:'iNVERSER la CASSE', removeSpaces:'Supprimer les espaces',
        history:'Historique',
        extrasTitle: 'Outils Suppl√©mentaires', noData: 'Aucune donn√©e...', exportError: 'Impossible d\'exporter DOCX',
        placeholder:'Collez votre texte ici...',
        titleUndo:'Annuler', titleRedo:'R√©tablir', titleTheme:'Changer de th√®me', titleLangUI:'Langue de l\'interface'
    },
    de: {
        stats:'Statistiken', words:'W√∂rter', chars:'Zeichen', sentences:'S√§tze', paragraphs:'Abs√§tze', lines:'Zeilen', read_time:'Lesezeit',
        quick:'Schnelle Aktionen', copy:'Kopieren', clear:'L√∂schen', find:'Suchen & √Ñndern', findPrompt:'Suchen (Gro√ü-/Kleinschreibung beachten):', replacePrompt:'Ersetzen durch:', copyError:'Kopieren fehlgeschlagen', upper:'GROSSBUCHSTABEN', lower:'kleinbuchstaben', title:'Titel',
        topFreq:'Top 5 h√§ufigste W√∂rter', topLongest:'Top 5 l√§ngste W√∂rter',
        readability:'Lesbarkeitsanalyse', score:'Flesch-Index', desc:'(H√∂her ist einfacher. >60 ist gut.)',
        extraTools:'Zus√§tzliche Werkzeuge', inverse:'uMGEKEHRTE sCHREIBUNG', removeSpaces:'Leerzeichen entfernen',
        history:'Verlauf',
        extrasTitle: 'Zus√§tzliche Werkzeuge', noData: 'Keine Daten...', exportError: 'DOCX konnte nicht exportiert werden',
        placeholder:'F√ºgen Sie Ihren Text hier ein...',
        titleUndo:'R√ºckg√§ngig', titleRedo:'Wiederholen', titleTheme:'Thema wechseln', titleLangUI:'Sprache der Benutzeroberfl√§che'
    },
    zh: {
        stats:'ÁªüËÆ°', words:'ËØç', chars:'Â≠óÁ¨¶', sentences:'Âè•Â≠ê', paragraphs:'ÊÆµËêΩ', lines:'Ë°å', read_time:'ÈòÖËØªÊó∂Èó¥',
        quick:'Âø´ÈÄüÊìç‰Ωú', copy:'Â§çÂà∂', clear:'Ê∏ÖÈô§', find:'Êü•ÊâæÂíå‰øÆÊîπ', findPrompt:'Êü•Êâæ (Âå∫ÂàÜÂ§ßÂ∞èÂÜô):', replacePrompt:'ÊõøÊç¢‰∏∫:', copyError:'Êó†Ê≥ïÂ§çÂà∂', upper:'Â§ßÂÜô', lower:'Â∞èÂÜô', title:'Ê†áÈ¢òÊ†ºÂºè',
        topFreq:'Ââç5‰∏™Â∏∏Áî®ËØç', topLongest:'Ââç5‰∏™ÊúÄÈïøËØç',
        readability:'ÂèØËØªÊÄßÂàÜÊûê', score:'Flesch ÂèØËØªÊÄßÂàÜÊï∞', desc:'(ÂàÜÊï∞Ë∂äÈ´òË∂äÂÆπÊòì„ÄÇ>60‰∏∫‰Ω≥„ÄÇ)',
        extraTools:'È¢ùÂ§ñÂ∑•ÂÖ∑', inverse:'Â§ßÂ∞èÂÜôÂèçËΩ¨', removeSpaces:'Âà†Èô§Â§ö‰ΩôÁ©∫Ê†º',
        history:'ÂéÜÂè≤ËÆ∞ÂΩï',
        extrasTitle: 'È¢ùÂ§ñÂ∑•ÂÖ∑', noData: 'ÊöÇÊó†Êï∞ÊçÆ...', exportError: 'Êó†Ê≥ïÂØºÂá∫ DOCX',
        placeholder:'Âú®Ê≠§Â§ÑÁ≤òË¥¥ÊÇ®ÁöÑÊñáÊú¨...',
        titleUndo:'Êí§Ê∂à', titleRedo:'ÈáçÂÅö', titleTheme:'ÂàáÊç¢‰∏ªÈ¢ò', titleLangUI:'ÁïåÈù¢ËØ≠Ë®Ä'
    },
    ja: {
        stats:'Áµ±Ë®à', words:'ÂçòË™û', chars:'ÊñáÂ≠ó', sentences:'Êñá', paragraphs:'ÊÆµËêΩ', lines:'Ë°å', read_time:'Ë™≠‰∫ÜÊôÇÈñì',
        quick:'„ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥', copy:'„Ç≥„Éî„Éº', clear:'„ÇØ„É™„Ç¢', find:'Ê§úÁ¥¢„Å®‰øÆÊ≠£', findPrompt:'Ê§úÁ¥¢ (Â§ßÊñáÂ≠ó„Å®Â∞èÊñáÂ≠ó„ÇíÂå∫Âà•):', replacePrompt:'ÁΩÆÊèõÂæå„ÅÆÊñáÂ≠óÂàó:', copyError:'„Ç≥„Éî„Éº„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü', upper:'Â§ßÊñáÂ≠ó', lower:'Â∞èÊñáÂ≠ó', title:'„Çø„Ç§„Éà„É´„Ç±„Éº„Çπ',
        topFreq:'È†ªÂá∫ÂçòË™û„Éà„ÉÉ„Éó5', topLongest:'ÊúÄ„ÇÇÈï∑„ÅÑÂçòË™û„Éà„ÉÉ„Éó5',
        readability:'ÂèØË™≠ÊÄßÂàÜÊûê', score:'Flesch ÂèØË™≠ÊÄß„Çπ„Ç≥„Ç¢', desc:'(È´ò„ÅÑ„Åª„Å©Á∞°Âçò„ÄÇ>60„ÅåËâØ„ÅÑ„ÄÇ)',
        extraTools:'ËøΩÂä†„ÉÑ„Éº„É´', inverse:'Â§ßÊñáÂ≠ó„Å®Â∞èÊñáÂ≠ó„ÇíÂèçËª¢', removeSpaces:'‰ΩôÂàÜ„Å™„Çπ„Éö„Éº„Çπ„ÇíÂâäÈô§',
        history:'Â±•Ê≠¥',
        extrasTitle: 'ËøΩÂä†„ÉÑ„Éº„É´', noData: '„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì...', exportError: 'DOCX „Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü',
        placeholder:'„Åì„Åì„Å´„ÉÜ„Ç≠„Çπ„Éà„ÇíË≤º„Çä‰ªò„Åë...',
        titleUndo:'ÂÖÉ„Å´Êàª„Åô', titleRedo:'„ÇÑ„ÇäÁõ¥„Åó', titleTheme:'„ÉÜ„Éº„Éû„ÇíÂàá„ÇäÊõø„Åà', titleLangUI:'UIË®ÄË™û'
    }
  };
  const langOptions = { vi: 'Ti·∫øng Vi·ªát', en: 'English', es: 'Espa√±ol', fr: 'Fran√ßais', de: 'Deutsch', zh: '‰∏≠Êñá', ja: 'Êó•Êú¨Ë™û' };
  
  yearEl.textContent = new Date().getFullYear();
  if (localStorage.getItem('countnkt_theme') === 'dark') { document.body.classList.remove('light'); } 
  else { document.body.classList.add('light'); }
  Object.keys(langOptions).forEach(key => {
      const option = document.createElement('option');
      option.value = key;
      option.textContent = langOptions[key];
      uiLang.appendChild(option);
  });
  if(localStorage.getItem('countnkt_lang')) uiLang.value = localStorage.getItem('countnkt_lang');
  
  if (!localStorage.getItem('countnkt_hint_shown')) {
      setTimeout(() => { menuHint.classList.add('show'); toggleExtras.classList.add('pulse'); }, 1500);
      setTimeout(() => {
          menuHint.classList.remove('show');
          toggleExtras.classList.remove('pulse');
      }, 7000);
  }

  const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[m]));

  const countSyllables = (word) => {
      word = word.toLowerCase();
      if(word.length <= 3) return 1;
      word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
      word = word.replace(/^y/, '');
      const matches = word.match(/[aeiouy]{1,2}/g);
      return matches ? matches.length : 0;
  };
  const calculateReadability = (words, sentences, syllables) => {
    if (words === 0 || sentences === 0) return 0.0;
    const score = 206.835 - 1.015 * (words / sentences) - 84.6 * (syllables / words);
    return Math.max(0, Math.min(100, score));
  };
  const analyze = (text) => {
    const trimmed = text.trim();
    const words = trimmed ? trimmed.match(/\p{L}[\p{L}\p{M}'‚Äô\-]*/gu) || [] : [];
    const sentences = trimmed ? trimmed.match(/[^.!?‚Ä¶]+[.!?‚Ä¶]+/g) || [] : [];
    const paragraphs = trimmed ? text.split(/\n\s*\n/).filter(p => p.trim() !== '') : [];
    const lines = text.split('\n');
    const syllables = words.reduce((acc, word) => acc + countSyllables(word), 0);
    return { text, words, sentences, paragraphs, lines, syllables };
  };

  const updateAll = debounce(() => {
    const txt = textarea.value || '';
    const an = analyze(txt);
    document.getElementById('statWords').textContent = an.words.length;
    document.getElementById('statChars').textContent = an.text.length;
    document.getElementById('statSentences').textContent = an.sentences.length || (an.words.length > 0 ? 1 : 0);
    document.getElementById('statParagraphs').textContent = an.paragraphs.length || (an.words.length > 0 ? 1 : 0);
    document.getElementById('statLines').textContent = an.lines.length;
    document.getElementById('statTime').textContent = formatReadingTime(an.words.length);
    statReadability.textContent = calculateReadability(an.words.length, an.sentences.length, an.syllables).toFixed(1);
    updateKeywords(an.words);
    saveHistory(an.text);
  }, 250);
  
  function formatReadingTime(wordCount) {
    const wpm = 238;
    const secondsTotal = (wordCount / wpm) * 60;
    if (secondsTotal < 60) {
        return `${secondsTotal.toFixed(1)}s`;
    } else if (secondsTotal < 3600) {
        const mins = Math.floor(secondsTotal / 60);
        const secs = Math.round(secondsTotal % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    } else {
        const hours = Math.floor(secondsTotal / 3600);
        const mins = Math.round((secondsTotal % 3600) / 60);
        return `${hours}h ${mins}m`;
    }
  }

  function updateKeywords(words){
    const total = words.length;
    const freq = {};
    words.forEach(w=>{ const key = w.toLowerCase(); if (key.length<=1) return; freq[key] = (freq[key]||0)+1; });
    const freqArr = Object.entries(freq).sort((a,b)=>b[1]-a[1]||a[0].localeCompare(b[0])).slice(0,5);
    renderKeywordList(freqList, freqArr.map(([k,v])=>({k,v})), total, 'freq');
    const unique = Object.keys(freq);
    const longArr = unique.sort((a,b)=>b.length-a.length).slice(0,5);
    renderKeywordList(longList, longArr.map(k=>({k,v:k.length})), 0, 'length');
  }
  function renderKeywordList(container, items, totalWords=0, type='freq'){
    container.innerHTML = '';
    if (!items || items.length===0){
      container.innerHTML = `<div class="small">${(i18n[uiLang.value] || i18n.vi).noData}</div>`; return;
    }
    const ul = document.createElement('ul'); ul.className='keyword-list';
    const maxVal = items.reduce((m,i)=>(i.v>m?i.v:m),0) || 1;
    items.forEach(it=>{
      const name = escapeHtml(it.k);
      const value = it.v;
      const percent = totalWords>0 && type==='freq' ? ((value/totalWords)*100).toFixed(1) + '%' : '';
      const ratio = Math.round((value / maxVal) * 100);
      const li = document.createElement('li');
      li.innerHTML = `<div style="flex:1;min-width:0;overflow:hidden;display:flex;align-items:center;gap:8px;"><strong style="display:block;white-space:nowrap;text-overflow:ellipsis;overflow:hidden" title="${name}">${name}</strong><div class="small">${percent}</div></div>
                      <div style="display:flex;align-items:center;gap:8px">
                        <div style="min-width:36px;text-align:right">${value}</div>
                        <div class="bar"><div class="bar-fill" style="width:${ratio}%"></div></div>
                      </div>`;
      ul.appendChild(li);
    });
    container.appendChild(ul);
  }

  function saveHistory(text){
    if (!text.trim()) return;
    if (state.history.length && state.history[state.history.length-1].text===text) return;
    state.history.push({text, time: new Date().toLocaleTimeString()});
    if (state.history.length>30) state.history.shift();
    renderHistory();
  }
  function renderHistory(){
    historyEl.innerHTML='';
    [...state.history].reverse().forEach((h)=>{
      const li = document.createElement('div');
      li.style.cssText = 'padding:8px; border-bottom:1px solid rgba(255,255,255,0.02); cursor:pointer;';
      const displayText = `${h.time} ‚Äî ${h.text.substring(0,80)}${h.text.length>80?'...':''}`;
      li.textContent = displayText;
      li.title = h.text;
      li.onclick = ()=>{ pushUndo(); textarea.value = h.text; updateAll(); };
      historyEl.appendChild(li);
    });
  }

  const pushUndo = () => {
    const cur = textarea.value;
    if (state.undoStack.length === 0 || state.undoStack[state.undoStack.length - 1] !== cur) {
        state.undoStack.push(cur);
        if (state.undoStack.length > 200) state.undoStack.shift();
        state.redoStack = [];
    }
  };

  textarea.addEventListener('input', () => { pushUndo(); updateAll(); });
  undoBtn.addEventListener('click', () => { if (state.undoStack.length > 1) { state.redoStack.push(state.undoStack.pop()); textarea.value = state.undoStack[state.undoStack.length - 1] || ''; updateAll(); } });
  redoBtn.addEventListener('click', () => { if (state.redoStack.length > 0) { const next = state.redoStack.pop(); textarea.value = next; state.undoStack.push(next); updateAll(); } });
  btnClear.addEventListener('click', () => { const t = i18n[uiLang.value] || i18n.vi; if (!confirm(t.clear + '?')) return; pushUndo(); textarea.value = ''; updateAll(); });
  btnCopy.addEventListener('click', async () => { const t = i18n[uiLang.value] || i18n.vi; try { await navigator.clipboard.writeText(textarea.value); alert(t.copy + '!'); } catch (e) { alert(t.copyError); } });
  btnFindReplace.addEventListener('click', () => { const t = i18n[uiLang.value] || i18n.vi; const f = prompt(t.findPrompt); if(f===null) return; const r = prompt(t.replacePrompt); if(r===null) return; pushUndo(); textarea.value = textarea.value.split(f).join(r); updateAll(); });
  btnUpper.addEventListener('click', () => { pushUndo(); textarea.value = textarea.value.toUpperCase(); updateAll(); });
  btnLower.addEventListener('click', () => { pushUndo(); textarea.value = textarea.value.toLowerCase(); updateAll(); });
  btnTitle.addEventListener('click', () => { pushUndo(); textarea.value = textarea.value.toLowerCase().replace(/\b\p{L}/gu, c => c.toUpperCase()); updateAll(); });
  btnInverseCase.addEventListener('click', () => { pushUndo(); textarea.value = [...textarea.value].map(c => c === c.toUpperCase() ? c.toLowerCase() : c.toUpperCase()).join(''); updateAll(); });
  btnRemoveSpaces.addEventListener('click', () => { pushUndo(); textarea.value = textarea.value.replace(/ +/g, ' ').trim(); updateAll(); });
  themeToggle.addEventListener('click', () => { document.body.classList.toggle('light'); localStorage.setItem('countnkt_theme', document.body.classList.contains('light') ? 'light' : 'dark'); });
  exportTxt.addEventListener('click', ()=>{ const blob = new Blob([textarea.value], {type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='CountNKT.txt'; a.click(); });
  exportDocx.addEventListener('click', async ()=>{ try{ const { Document, Packer, Paragraph } = docx; const doc = new Document({ sections: [{ children: textarea.value.split('\n').map(p => new Paragraph(p)) }] }); const blob = await Packer.toBlob(doc); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='CountNKT.docx'; a.click(); }catch(e){ console.error(e); alert(i18n[uiLang.value]?.exportError || 'Could not export.'); }});
  
  const openMenu = () => { extrasPanel.classList.add('show'); overlay.classList.add('show'); };
  const closeMenu = () => { extrasPanel.classList.remove('show'); overlay.classList.remove('show'); };
  toggleExtras.addEventListener('click', () => {
    openMenu();
    if (menuHint.classList.contains('show')) {
        menuHint.classList.remove('show');
        toggleExtras.classList.remove('pulse');
        localStorage.setItem('countnkt_hint_shown', 'true');
    }
  });
  closeExtras.addEventListener('click', closeMenu);
  overlay.addEventListener('click', closeMenu);
  
  const translateUI = (lang) => {
    localStorage.setItem('countnkt_lang', lang);
    const t = i18n[lang] || i18n.vi;
    document.documentElement.lang = lang.split('-')[0];
    const elementsToTranslate = {
        'titleStats': 'stats', 'lblWords': 'words', 'lblChars': 'chars', 'lblSentences': 'sentences', 'lblParagraphs': 'paragraphs', 'lblLines': 'lines', 'lblTime': 'read_time',
        'titleQuick': 'quick', 'titleFreq': 'topFreq', 'titleLongest': 'topLongest',
        'titleExtrasPanel': 'extrasTitle', 'titleReadability': 'readability', 'lblReadability': 'score', 'descReadability': 'desc', 'titleExtraTools': 'extraTools', 'titleHistory': 'history'
    };
    for(const id in elementsToTranslate){
        const el = document.getElementById(id);
        if(el) el.textContent = t[elementsToTranslate[id]];
    }

    btnCopy.firstChild.nodeValue = 'üìã ' + t.copy;
    btnClear.firstChild.nodeValue = 'üßπ ' + t.clear;
    btnFindReplace.firstChild.nodeValue = 'üîç ' + t.find;
    btnUpper.firstChild.nodeValue = 'üî† ' + t.upper;
    btnLower.firstChild.nodeValue = 'üî° ' + t.lower;
    btnTitle.firstChild.nodeValue = 'üÖ£ ' + t.title;
    btnInverseCase.textContent = t.inverse;
    btnRemoveSpaces.textContent = t.removeSpaces;
    textarea.placeholder = t.placeholder;

    // Translate titles
    undoBtn.title = t.titleUndo;
    redoBtn.title = t.titleRedo;
    themeToggle.title = t.titleTheme;
    uiLang.title = t.titleLangUI;
  };
  uiLang.addEventListener('change', (e) => translateUI(e.target.value));
  
  translateUI(uiLang.value);
  pushUndo();
  updateAll();
  document.addEventListener('visibilitychange', () => { if (!document.hidden) updateAll(); });

})();
</script>
</body>
</html>
